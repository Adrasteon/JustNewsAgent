# JustNews Website Apache Configuration
# Place this file in /etc/apache2/sites-available/justnews.conf
# Then run: sudo a2ensite justnews.conf && sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName justnews.local
    ServerAlias www.justnews.local

    # Document root pointing to the JustNews web interface
    DocumentRoot /home/adra/justnewsagent/JustNewsAgent/agents/dashboard/web_interface

    # Directory configuration
    <Directory /home/adra/justnewsagent/JustNewsAgent/agents/dashboard/web_interface>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        # Enable CORS for API calls to the dashboard
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

        # Handle OPTIONS requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Directory>

    # Proxy API requests to the dashboard backend
    ProxyPass /api http://localhost:8013/api
    ProxyPassReverse /api http://localhost:8013/api

    ProxyPass /gpu http://localhost:8013/gpu
    ProxyPassReverse /gpu http://localhost:8013/gpu

    ProxyPass /send_command http://localhost:8013/send_command
    ProxyPassReverse /send_command http://localhost:8013/send_command

    ProxyPass /get_status http://localhost:8013/get_status
    ProxyPassReverse /get_status http://localhost:8013/get_status

    # Log configuration
    ErrorLog ${APACHE_LOG_DIR}/justnews_error.log
    CustomLog ${APACHE_LOG_DIR}/justnews_access.log combined

    # Security headers
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </IfModule>
</VirtualHost>

# HTTPS Configuration (Optional - requires SSL certificate)
<VirtualHost *:443>
    ServerName justnews.local
    ServerAlias www.justnews.local

    DocumentRoot /home/adra/justnewsagent/JustNewsAgent/agents/dashboard/web_interface

    <Directory /home/adra/justnewsagent/JustNewsAgent/agents/dashboard/web_interface>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Directory>

    # Proxy configuration (same as HTTP)
    ProxyPass /api http://localhost:8013/api
    ProxyPassReverse /api http://localhost:8013/api

    ProxyPass /gpu http://localhost:8013/gpu
    ProxyPassReverse /gpu http://localhost:8013/gpu

    ProxyPass /send_command http://localhost:8013/send_command
    ProxyPassReverse /send_command http://localhost:8013/send_command

    ProxyPass /get_status http://localhost:8013/get_status
    ProxyPassReverse /get_status http://localhost:8013/get_status

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/justnews.crt
    SSLCertificateKeyFile /etc/ssl/private/justnews.key

    # SSL Security
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    ErrorLog ${APACHE_LOG_DIR}/justnews_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/justnews_ssl_access.log combined

    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>
</VirtualHost>