<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustNewsAgent GPU Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }

        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        .gpu-list {
            margin-top: 15px;
        }

        .gpu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .gpu-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .gpu-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .chart-controls button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .chart-controls button:hover {
            background: #0056b3;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .agent-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
            transition: transform 0.2s;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .agent-card.inactive {
            opacity: 0.6;
            border-left-color: #95a5a6;
        }

        .agent-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .agent-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .alerts-section {
            margin-top: 20px;
        }

        .alert {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-left-color: #f39c12;
            color: #856404;
        }

        .alert-error {
            background-color: #f8d7da;
            border-left-color: #e74c3c;
            color: #721c24;
        }

        .alert-info {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 20px 0;
            transition: transform 0.2s;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ JustNewsAgent GPU Dashboard</h1>
            <p>Real-time GPU monitoring and performance analytics</p>
        </div>

        <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh Dashboard</button>

        <div class="dashboard-grid">
            <!-- GPU Summary Card -->
            <div class="card">
                <h3>üéØ GPU Summary</h3>
                <div class="metric-grid" id="gpu-summary">
                    <div class="metric">
                        <span class="metric-value" id="total-gpus">0</span>
                        <span class="metric-label">Total GPUs</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="active-agents">0</span>
                        <span class="metric-label">Active Agents</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="gpu-util-avg">0%</span>
                        <span class="metric-label">Avg Utilization</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="memory-used">0MB</span>
                        <span class="metric-label">Memory Used</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="active-allocations">0</span>
                        <span class="metric-label">Active Allocations</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="success-rate">0%</span>
                        <span class="metric-label">Success Rate</span>
                    </div>
                </div>
            </div>

            <!-- GPU Manager Status Card -->
            <div class="card">
                <h3>‚öôÔ∏è GPU Manager Status</h3>
                <div class="metric-grid" id="manager-status">
                    <div class="metric">
                        <span class="status-indicator" id="manager-status-indicator"></span>
                        <span class="metric-value" id="manager-available">No</span>
                        <span class="metric-label">Manager Available</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="total-requests">0</span>
                        <span class="metric-label">Total Requests</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="cpu-fallbacks">0</span>
                        <span class="metric-label">CPU Fallbacks</span>
                    </div>
                    <div class="metric">
                        <span class="metric-value" id="gpu-recoveries">0</span>
                        <span class="metric-label">GPU Recoveries</span>
                    </div>
                </div>
            </div>

            <!-- GPU Details Card -->
            <div class="card">
                <h3>üîß GPU Details</h3>
                <div id="gpu-details">
                    <p>Loading GPU information...</p>
                </div>
            </div>

            <!-- Agent Usage Card -->
            <div class="card">
                <h3>ü§ñ Agent GPU Usage</h3>
                <div id="agent-usage">
                    <p>Loading agent information...</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä GPU Utilization Trend (Live)</h3>
                <div class="chart-controls">
                    <select id="utilization-time-range" aria-label="Select time range for utilization chart">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                    </select>
                    <button onclick="refreshUtilizationChart()">üîÑ Refresh</button>
                </div>
                <div class="chart-container">
                    <canvas id="utilizationChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üß† Memory Usage Trend (Live)</h3>
                <div class="chart-controls">
                    <select id="memory-time-range" aria-label="Select time range for memory chart">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                    </select>
                    <button onclick="refreshMemoryChart()">üîÑ Refresh</button>
                </div>
                <div class="chart-container">
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üå°Ô∏è Temperature Trend (Live)</h3>
                <div class="chart-controls">
                    <select id="temperature-time-range" aria-label="Select time range for temperature chart">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                    </select>
                    <button onclick="refreshTemperatureChart()">üîÑ Refresh</button>
                </div>
                <div class="chart-container">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üìà Agent Performance (Live)</h3>
                <div class="chart-controls">
                    <select id="performance-time-range" aria-label="Select time range for performance chart">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                    </select>
                    <button onclick="refreshPerformanceChart()">üîÑ Refresh</button>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="card alerts-section">
            <h3>üö® Alerts & Notifications</h3>
            <div id="alerts-container">
                <p>No alerts at this time.</p>
            </div>
        </div>

        <div class="last-update" id="last-update">
            Last updated: Never
        </div>
    </div>

    <script>
        let utilizationChart, memoryChart, temperatureChart, performanceChart;
        let dashboardData = {};
        let updateInterval;

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM DD'
                            }
                        }
                    }
                }
            };

            // GPU Utilization Chart
            const ctx1 = document.getElementById('utilizationChart').getContext('2d');
            utilizationChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'GPU Utilization (%)',
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        data: [],
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Utilization (%)'
                            }
                        }
                    }
                }
            });

            // Memory Usage Chart
            const ctx2 = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Memory Used (GB)',
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        data: [],
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Memory (GB)'
                            }
                        }
                    }
                }
            });

            // Temperature Chart
            const ctx3 = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'GPU Temperature (¬∞C)',
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        data: [],
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    }
                }
            });

            // Performance Chart
            const ctx4 = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx4, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Processing Time (ms)',
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        data: [],
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (ms)'
                            }
                        }
                    }
                }
            });
        }

        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const response = await fetch('/gpu/dashboard');
                const data = await response.json();

                if (data.status === 'success') {
                    dashboardData = data;
                    updateDashboard(data);
                    updateCharts(data);
                    document.getElementById('last-update').textContent =
                        `Last updated: ${new Date(data.timestamp * 1000).toLocaleString()}`;
                }
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }

        // Update dashboard display
        function updateDashboard(data) {
            const summary = data.summary || {};

            // Update summary metrics
            document.getElementById('total-gpus').textContent = summary.total_gpus || 0;
            document.getElementById('active-agents').textContent = summary.active_agents || 0;
            document.getElementById('gpu-util-avg').textContent = `${summary.gpu_utilization_avg?.toFixed(1) || 0}%`;
            document.getElementById('memory-used').textContent = `${summary.total_memory_used_mb || 0}MB`;

            // Update manager status
            const manager = data.gpu_manager || {};
            const managerIndicator = document.getElementById('manager-status-indicator');
            const managerAvailable = document.getElementById('manager-available');

            if (manager.available) {
                managerIndicator.className = 'status-indicator status-healthy';
                managerAvailable.textContent = 'Yes';
            } else {
                managerIndicator.className = 'status-indicator status-warning';
                managerAvailable.textContent = 'No';
            }

            document.getElementById('active-allocations').textContent = summary.active_allocations || 0;
            document.getElementById('total-requests').textContent = summary.total_allocation_requests || 0;

            const successRate = summary.total_allocation_requests > 0 ?
                ((summary.successful_allocations / summary.total_allocation_requests) * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = `${successRate}%`;

            // Update GPU details
            updateGPUDetails(data.gpu_info);

            // Update agent usage
            updateAgentUsage(data.agent_usage);

            // Update alerts
            updateAlerts(data);
        }

        // Update GPU details display
        function updateGPUDetails(gpuInfo) {
            const container = document.getElementById('gpu-details');

            if (gpuInfo.status === 'success' && gpuInfo.gpus) {
                const gpuList = gpuInfo.gpus.map(gpu => `
                    <div class="gpu-item">
                        <div class="gpu-name">${gpu.name} (${gpu.index})</div>
                        <div class="gpu-stats">
                            <span>Memory: ${gpu.memory_used_mb}/${gpu.memory_total_mb}MB</span>
                            <span>Util: ${gpu.gpu_utilization_percent}%</span>
                            <span>Temp: ${gpu.temperature_celsius}¬∞C</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `<div class="gpu-list">${gpuList}</div>`;
            } else {
                container.innerHTML = '<p>Unable to load GPU information</p>';
            }
        }

        // Update agent usage display
        function updateAgentUsage(agentUsage) {
            const container = document.getElementById('agent-usage');

            if (agentUsage.status === 'success' && agentUsage.agents) {
                const agentCards = Object.entries(agentUsage.agents).map(([name, data]) => `
                    <div class="agent-card ${data.active ? '' : 'inactive'}">
                        <div class="agent-name">${name.replace('_', ' ').toUpperCase()}</div>
                        <div class="agent-metric">
                            <span>Status:</span>
                            <span>${data.active ? 'Active' : 'Inactive'}</span>
                        </div>
                        <div class="agent-metric">
                            <span>Memory:</span>
                            <span>${data.memory_used_mb || 0}MB</span>
                        </div>
                        <div class="agent-metric">
                            <span>GPU Util:</span>
                            <span>${data.gpu_utilization_percent || 0}%</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `<div class="agent-grid">${agentCards}</div>`;
            } else {
                container.innerHTML = '<p>Unable to load agent information</p>';
            }
        }

        // Update alerts display
        function updateAlerts(data) {
            const container = document.getElementById('alerts-container');

            // Generate alerts from GPU data
            const alerts = [];

            if (data.gpu_info && data.gpu_info.gpus) {
                data.gpu_info.gpus.forEach(gpu => {
                    if (gpu.temperature_celsius > 80) {
                        alerts.push({
                            type: 'warning',
                            message: `GPU ${gpu.index} temperature is high: ${gpu.temperature_celsius}¬∞C`
                        });
                    }
                    if ((gpu.memory_used_mb / gpu.memory_total_mb) > 0.9) {
                        alerts.push({
                            type: 'warning',
                            message: `GPU ${gpu.index} memory usage is high: ${((gpu.memory_used_mb / gpu.memory_total_mb) * 100).toFixed(1)}%`
                        });
                    }
                });
            }

            if (alerts.length > 0) {
                const alertHtml = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        ${alert.message}
                    </div>
                `).join('');
                container.innerHTML = alertHtml;
            } else {
                container.innerHTML = '<p>No alerts at this time.</p>';
            }
        }

        // Update charts with new data
        async function updateCharts(data) {
            // Update real-time charts with current data
            const now = new Date();

            // Update utilization chart
            if (utilizationChart) {
                utilizationChart.data.datasets[0].data.push({
                    x: now,
                    y: data.summary?.gpu_utilization_avg || 0
                });

                if (utilizationChart.data.datasets[0].data.length > 50) {
                    utilizationChart.data.datasets[0].data.shift();
                }
                utilizationChart.update();
            }

            // Update memory chart
            if (memoryChart) {
                const memoryGB = (data.summary?.total_memory_used_mb || 0) / 1024;
                memoryChart.data.datasets[0].data.push({
                    x: now,
                    y: memoryGB
                });

                if (memoryChart.data.datasets[0].data.length > 50) {
                    memoryChart.data.datasets[0].data.shift();
                }
                memoryChart.update();
            }

            // Update temperature chart
            if (temperatureChart && data.gpu_info?.gpus?.length > 0) {
                const avgTemp = data.gpu_info.gpus.reduce((sum, gpu) => sum + (gpu.temperature_celsius || 0), 0) / data.gpu_info.gpus.length;
                temperatureChart.data.datasets[0].data.push({
                    x: now,
                    y: avgTemp
                });

                if (temperatureChart.data.datasets[0].data.length > 50) {
                    temperatureChart.data.datasets[0].data.shift();
                }
                temperatureChart.update();
            }

            // Update performance chart (placeholder for now)
            if (performanceChart) {
                // This would be populated with actual performance metrics
                const mockPerformance = Math.random() * 100 + 50; // Mock data
                performanceChart.data.datasets[0].data.push({
                    x: now,
                    y: mockPerformance
                });

                if (performanceChart.data.datasets[0].data.length > 50) {
                    performanceChart.data.datasets[0].data.shift();
                }
                performanceChart.update();
            }
        }

        // Load historical data for charts
        async function loadHistoricalData(chartType, hours) {
            try {
                const response = await fetch(`/gpu/history/db?hours=${hours}&metric=${chartType}`);
                const data = await response.json();

                if (data.status === 'success' && data.data) {
                    const chartMap = {
                        'utilization': utilizationChart,
                        'memory': memoryChart,
                        'temperature': temperatureChart,
                        'performance': performanceChart
                    };

                    const chart = chartMap[chartType];
                    if (chart) {
                        chart.data.datasets[0].data = data.data.map(point => ({
                            x: new Date(point.timestamp * 1000),
                            y: point.value
                        }));
                        chart.update();
                    }
                }
            } catch (error) {
                console.error(`Error loading historical ${chartType} data:`, error);
            }
        }

        // Refresh chart functions
        function refreshUtilizationChart() {
            const hours = document.getElementById('utilization-time-range').value;
            loadHistoricalData('utilization', hours);
        }

        function refreshMemoryChart() {
            const hours = document.getElementById('memory-time-range').value;
            loadHistoricalData('memory', hours);
        }

        function refreshTemperatureChart() {
            const hours = document.getElementById('temperature-time-range').value;
            loadHistoricalData('temperature', hours);
        }

        function refreshPerformanceChart() {
            const hours = document.getElementById('performance-time-range').value;
            loadHistoricalData('performance', hours);
        }

        // Refresh dashboard manually
        function refreshDashboard() {
            fetchDashboardData();
        }

        // Initialize dashboard
        async function initDashboard() {
            initCharts();

            // Load initial data
            await fetchDashboardData();

            // Load historical data for all charts (24 hours default)
            await Promise.all([
                loadHistoricalData('utilization', 24),
                loadHistoricalData('memory', 24),
                loadHistoricalData('temperature', 24),
                loadHistoricalData('performance', 24)
            ]);

            // Set up auto-refresh every 5 seconds
            updateInterval = setInterval(fetchDashboardData, 5000);
        }

        // Start dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>